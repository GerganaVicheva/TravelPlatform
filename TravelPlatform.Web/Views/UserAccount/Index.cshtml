@model TravelPlatform.ViewModels.UserProfileViewModel

@{
	ViewData["Title"] = "Profile";
	var currentUserId = ViewData["CurrentUserId"] as string;
	var isFollowing = Model.Followers?.Any(f => f.UserId == currentUserId) ?? false;
}

@section Styles {
	<link href="~/css/account-index.css" rel="stylesheet" asp-append-version="true" />
	<link href="~/css/modal-comments.css" rel="stylesheet" asp-append-version="true" />
	<link href="~/css/follow-modal.css" rel="stylesheet" asp-append-version="true" />
}


<div class="container">
	<!-- Profile Section -->
	<div class="profile-container">
		<div class="profile-header">
			@if (Model.ProfilePictureUrl == null)
			{
				<img src="~/images/user.png" alt="Default Profile Picture" class="profile-picture" style="padding: 10px !important;">
			}
			else
			{
				<img src="@Model.ProfilePictureUrl" alt="Profile Picture" class="profile-picture">
			}
			<div class="profile-info">
				<h1 class="username">@Model.Username</h1>
				@if (Model.Bio == null)
				{
					<p class="bio">This user has not provided a bio.</p>
				}
				else
				{
					<p class="bio">@Model.Bio</p>
				}
				<div class="stats">
					<div class="stat-item">
						<div class="stat-value">@Model.Posts.Count</div>
						<div class="stat-label">POSTS</div>
					</div>
					<div class="stat-item">
						<div class="stat-value" id="followerCount">@(Model.Followers?.Count ?? 0)</div>
						<div class="stat-label">
							<button style="border: none; background-color: transparent;" class="stat-label" id="showFollowersBtn" data-user-id="@Model.UserId">FOLLOWERS</button>
						</div>
					</div>
					<div class="stat-item">
						<div class="stat-value" id="followingCount">@(Model.Following?.Count ?? 0)</div>
						<div class="stat-label">
							<button style="border: none; background-color: transparent;" class="stat-label" id="showFollowingBtn" data-user-id="@Model.UserId">FOLLOWING</button>
						</div>
					</div>
				</div>
				<div class="mt-3">
					@if (Model.UserId == currentUserId || User.IsInRole("Administrator"))
					{
						<a asp-area="" asp-controller="UserAccount" asp-action="Edit" asp-route-userId="@Model.UserId" class="btn btn-outline-custom me-2">Edit Profile</a>
						<a asp-area="" asp-controller="Post" asp-action="Add" asp-route-userId="@Model.UserId" class="btn btn-outline-custom">Add Post</a>
					}
					else
					{
						@Html.AntiForgeryToken()

						<button id="followBtn"
								class="btn btn-outline-custom"
								data-user-id="@Model.UserId"
								data-following="@isFollowing">
							@(isFollowing ? "Unfollow" : "Follow")
						</button>
					}
				</div>
			</div>
		</div>
	</div>

	<!-- Posts Section -->
	<h2 class="section-title">Recent Posts</h2>
	<div class="posts-container">
		<div class="row">
			@if (Model.Posts == null || !Model.Posts.Any())
			{
				<div class="col-md-12 text-center" style="margin-bottom: 100px;">
					<p class="no-posts-message">No posts available.</p>
				</div>
			}
			else
			{
				@foreach (var post in Model.Posts)
				{
					<div class="col-md-12 mb-4">
						<div class="post-card d-flex align-content-center" id="post-@post.Id">
							<div class="post-img flex-grow-1 d-flex align-items-center justify-content-center">
								@if (post.ImageUrl == null)
								{
									<img src="~/images/place.jpg" alt="Default Post Image" class="post-image" style="padding: 20px; border-radius: 30px !important;">
								}
								else
								{
									<img src="@post.ImageUrl" alt="Post Image" class="post-image" style="padding: 20px; border-radius: 30px !important;">
								}
							</div>
							<div class="post-content flex-grow-1">
								<h3 class="post-title">@post.Title</h3>
								<div class="destination-details">
									<span class="destination-label">Location:</span>
									<span class="destination-value">@post.DestinationName</span>
									<span class="destination-separator">|</span>
									<span class="destination-label">Town:</span>
									<span class="destination-value">@post.Town</span>
									<span class="destination-separator">|</span>
									<span class="destination-label">Country:</span>
									<span class="destination-value">@post.Country</span>
								</div>
								<p class="post-description">@post.Content</p>
								<div class="post-meta">
									<span><i class="far fa-calendar"></i> @post.CreatedOn.ToString("MMMM d, yyyy")</span>
									<div class="post-actions">
										@* <a asp-controller="Post" asp-action="Like" asp-route-postId="@post.Id" *@
										@*    style="text-decoration: none;" *@
										@*    class="action-button like @(post.IsLikedByCurrentUser ? "liked" : "")" *@
										@*    title="@(post.IsLikedByCurrentUser ? "Dislike" : "Like")"> *@
										@* 	<i class="bi @(post.IsLikedByCurrentUser ? "bi-heart-fill text-danger" : "bi-heart")"></i> *@
										@* 	@post.Likes *@
										@* </a> *@
										<a href="#" class="action-button like-btn" data-post-id="@post.Id" data-liked="@post.IsLikedByCurrentUser"
										   style="text-decoration: none;" title="@(post.IsLikedByCurrentUser ? "Dislike" : "Like")">
											<i class="bi @(post.IsLikedByCurrentUser ? "bi-heart-fill text-danger" : "bi-heart")"></i>
											<span class="like-count">@post.Likes</span>
										</a>
										@* <button class="action-button" title="Comments"><i class="bi bi-chat-right-dots"></i> @post.Comments</button> *@
										<a href="#"
										   class="action-button open-comments-modal"
										   style="text-decoration: none;"
										   data-post-id="@post.Id"
										   data-post-image="@(post.ImageUrl ?? "/images/place.jpg")"
										   data-username="@Model.Username"
										   title="View Comments">
											<i class="bi bi-chat-right-dots"></i> @post.Comments
										</a>

									</div>
								</div>
								@if (Model.UserId == currentUserId)
								{
									<div class="user-control-btns">
										<a asp-controller="Post" asp-action="Edit" asp-route-postId="@post.Id" class="btn btn-primary">Edit Post</a>
										<form asp-controller="Post" asp-action="Delete" method="post">
											@Html.AntiForgeryToken()

											<input type="hidden" name="postId" value="@post.Id" />
											<button type="submit" class="btn btn-danger"
													onclick="return confirm('Are you sure you want to delete this post?')">
												Delete Post
											</button>
										</form>
									</div>
								}
							</div>
						</div>
					</div>
				}

				<!-- Comments Modal -->
				<div id="commentsModal" class="modal-overlay d-none">
					<div class="modal-content">
						<button class="close-modal">&times;</button>
						<div class="modal-body d-flex">
							<!-- Left side: Post Image -->
							<div class="modal-image w-50">
								<img id="modal-post-image" src="" alt="Post Image" />
							</div>
							<!-- Right side: Comments -->
							<div class="modal-comments w-50">
								<h4 id="modal-username" style="font-size: 15px;"></h4>
								<div id="commentsList">
									<!-- AJAX-loaded comments go here -->
								</div>
								<form id="addCommentForm">
									@Html.AntiForgeryToken()

									<textarea name="content" placeholder="Add a comment..." required></textarea>
									<input type="hidden" name="postId" id="modalPostId" />
									<button type="submit">Post Comment</button>
								</form>
							</div>
						</div>
					</div>
				</div>


				<div id="followModal" class="custom-modal-overlay hidden">
					<div class="custom-modal-content">
						<button id="closeFollowModal" class="custom-close-modal me-2" aria-label="Close">&times;</button>
						<h2 id="customModalTitle" style="color: var(--brown); border-bottom: 1px solid var(--brown); padding-bottom: 8px;"></h2>
						<div id="customModalBody"></div>
					</div>
				</div>
			}
		</div>
	</div>
</div>

@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="~/js/ajax-like-dislike.js" asp-append-version="true"></script>
	<script src="~/js/ajax-comments.js" asp-append-version="true"></script>
	<script src="~/js/view-post.js" asp-append-version="true"></script>
	<script src="~/js/ajax-follow.js" asp-append-version="true"></script>
	<script src="~/js/ajax-follow-modal.js" asp-append-version="true"></script>
}
